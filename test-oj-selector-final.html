<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Seletor de OJs V2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #0056b3;
        }
        
        /* Estilos do OJ Selector */
        .oj-selector {
            position: relative;
            margin-bottom: 15px;
        }
        
        .oj-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .oj-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .oj-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .oj-option:hover {
            background-color: #f8f9fa;
        }
        
        .oj-option.selected {
            background-color: #e3f2fd;
        }
        
        .oj-selected-display {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            min-height: 40px;
        }
        
        .oj-tag {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .oj-tag .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Teste Final - Seletor de Órgãos Julgadores V2</h1>
        
        <div class="debug-info" id="debugInfo">
            <strong>Status de Depuração:</strong><br>
            Carregando...
        </div>
        
        <button class="btn" onclick="openModal()">Abrir Modal Servidor V2</button>
        <button class="btn" onclick="runTests()">Executar Testes</button>
        <button class="btn" onclick="clearDebug()">Limpar Debug</button>
        
        <!-- Modal Servidor V2 -->
        <div id="servidor-v2-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Configuração do Servidor V2</h2>
                
                <div class="form-group">
                    <label for="cpf-servidor-v2">CPF do Servidor:</label>
                    <input type="text" id="cpf-servidor-v2" placeholder="000.000.000-00">
                </div>
                
                <div class="form-group">
                    <label>Órgãos Julgadores:</label>
                    <div id="oj-selector-v2"></div>
                </div>
                
                <div class="form-group">
                    <button class="btn" onclick="testOJSelector()">Testar Seletor</button>
                    <button class="btn" onclick="loadExampleOJs()">Carregar Exemplos</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Mock data para teste
        const mockOJData = {
            "Adamantina": ["1ª Vara do Trabalho de Adamantina", "2ª Vara do Trabalho de Adamantina"],
            "Americana": ["1ª Vara do Trabalho de Americana", "2ª Vara do Trabalho de Americana"],
            "Amparo": ["Vara do Trabalho de Amparo"],
            "Araraquara": ["1ª Vara do Trabalho de Araraquara", "2ª Vara do Trabalho de Araraquara"],
            "Araçatuba": ["1ª Vara do Trabalho de Araçatuba", "2ª Vara do Trabalho de Araçatuba"],
            "Assis": ["Vara do Trabalho de Assis"],
            "Barretos": ["Vara do Trabalho de Barretos"],
            "Bauru": ["1ª Vara do Trabalho de Bauru", "2ª Vara do Trabalho de Bauru", "3ª Vara do Trabalho de Bauru"],
            "Botucatu": ["Vara do Trabalho de Botucatu"],
            "Campinas": ["1ª Vara do Trabalho de Campinas", "2ª Vara do Trabalho de Campinas", "3ª Vara do Trabalho de Campinas"],
            "Franca": ["1ª Vara do Trabalho de Franca", "2ª Vara do Trabalho de Franca"],
            "Guarulhos": ["1ª Vara do Trabalho de Guarulhos", "2ª Vara do Trabalho de Guarulhos"],
            "Jundiaí": ["Vara do Trabalho de Jundiaí"],
            "Limeira": ["Vara do Trabalho de Limeira"],
            "Marília": ["Vara do Trabalho de Marília"],
            "Piracicaba": ["1ª Vara do Trabalho de Piracicaba", "2ª Vara do Trabalho de Piracicaba"],
            "Presidente Prudente": ["1ª Vara do Trabalho de Presidente Prudente", "2ª Vara do Trabalho de Presidente Prudente"],
            "Ribeirão Preto": ["1ª Vara do Trabalho de Ribeirão Preto", "2ª Vara do Trabalho de Ribeirão Preto", "3ª Vara do Trabalho de Ribeirão Preto"],
            "Santos": ["1ª Vara do Trabalho de Santos", "2ª Vara do Trabalho de Santos", "3ª Vara do Trabalho de Santos"],
            "São José do Rio Preto": ["1ª Vara do Trabalho de São José do Rio Preto", "2ª Vara do Trabalho de São José do Rio Preto"],
            "São José dos Campos": ["1ª Vara do Trabalho de São José dos Campos", "2ª Vara do Trabalho de São José dos Campos"],
            "Sorocaba": ["1ª Vara do Trabalho de Sorocaba", "2ª Vara do Trabalho de Sorocaba", "3ª Vara do Trabalho de Sorocaba"],
            "Taubaté": ["Vara do Trabalho de Taubaté"]
        };
        
        // Classe OJSelector simplificada para teste
        class OJSelector {
            constructor(containerId, ojList) {
                this.containerId = containerId;
                this.ojList = ojList || [];
                this.selectedOJs = [];
                this.filteredOJs = [...this.ojList];
                this.container = document.getElementById(containerId);
                
                if (!this.container) {
                    throw new Error(`Container com ID '${containerId}' não encontrado`);
                }
                
                this.init();
            }
            
            init() {
                this.createHTML();
                this.setupEventListeners();
                this.renderOptions();
                this.updateSelectedDisplay();
                logDebug(`OJSelector inicializado com ${this.ojList.length} órgãos`);
            }
            
            createHTML() {
                this.container.innerHTML = `
                    <div class="oj-selector">
                        <input type="text" class="oj-search-input" placeholder="Digite para buscar órgãos julgadores...">
                        <div class="oj-dropdown"></div>
                        <div class="oj-selected-display"></div>
                        <input type="hidden" class="oj-hidden-input">
                    </div>
                `;
                
                this.searchInput = this.container.querySelector('.oj-search-input');
                this.dropdown = this.container.querySelector('.oj-dropdown');
                this.selectedDisplay = this.container.querySelector('.oj-selected-display');
                this.hiddenInput = this.container.querySelector('.oj-hidden-input');
            }
            
            setupEventListeners() {
                this.searchInput.addEventListener('input', (e) => {
                    this.filterOptions(e.target.value);
                });
                
                this.searchInput.addEventListener('focus', () => {
                    this.showDropdown();
                });
                
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.hideDropdown();
                    }
                });
            }
            
            filterOptions(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                
                if (!term) {
                    this.filteredOJs = [...this.ojList];
                } else {
                    this.filteredOJs = this.ojList.filter(oj => 
                        oj.toLowerCase().includes(term)
                    );
                }
                
                this.renderOptions();
                this.showDropdown();
            }
            
            renderOptions() {
                if (this.filteredOJs.length === 0) {
                    this.dropdown.innerHTML = '<div class="oj-option">Nenhum órgão encontrado</div>';
                    return;
                }
                
                const optionsHTML = this.filteredOJs.slice(0, 50).map(oj => {
                    const isSelected = this.selectedOJs.includes(oj);
                    return `
                        <div class="oj-option ${isSelected ? 'selected' : ''}" data-oj="${oj}">
                            <input type="checkbox" ${isSelected ? 'checked' : ''}> ${oj}
                        </div>
                    `;
                }).join('');
                
                this.dropdown.innerHTML = optionsHTML;
                
                // Add click listeners
                this.dropdown.querySelectorAll('.oj-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const oj = option.dataset.oj;
                        this.toggleOJ(oj);
                    });
                });
            }
            
            toggleOJ(oj) {
                const index = this.selectedOJs.indexOf(oj);
                if (index > -1) {
                    this.selectedOJs.splice(index, 1);
                } else {
                    this.selectedOJs.push(oj);
                }
                
                this.updateSelectedDisplay();
                this.updateHiddenInput();
                this.renderOptions();
                
                logDebug(`OJ ${index > -1 ? 'removido' : 'adicionado'}: ${oj}`);
            }
            
            updateSelectedDisplay() {
                if (this.selectedOJs.length === 0) {
                    this.selectedDisplay.innerHTML = '<em>Nenhum órgão selecionado</em>';
                } else {
                    const tagsHTML = this.selectedOJs.map(oj => `
                        <span class="oj-tag">
                            ${oj}
                            <span class="remove" onclick="window.ojSelectors['${this.containerId}'].removeOJ('${oj}')">&times;</span>
                        </span>
                    `).join('');
                    this.selectedDisplay.innerHTML = tagsHTML;
                }
            }
            
            removeOJ(oj) {
                this.toggleOJ(oj);
            }
            
            updateHiddenInput() {
                this.hiddenInput.value = JSON.stringify(this.selectedOJs);
            }
            
            showDropdown() {
                this.dropdown.style.display = 'block';
            }
            
            hideDropdown() {
                this.dropdown.style.display = 'none';
            }
            
            getSelectedOJs() {
                return [...this.selectedOJs];
            }
        }
        
        // Variáveis globais
        window.ojSelectors = {};
        window.ojList = [];
        
        // Funções de debug
        function logDebug(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<br>[${timestamp}] ${message}`;
            console.log(`[DEBUG] ${message}`);
        }
        
        function clearDebug() {
            document.getElementById('debugInfo').innerHTML = '<strong>Status de Depuração:</strong><br>Debug limpo.';
        }
        
        // Funções do modal
        function openModal() {
            document.getElementById('servidor-v2-modal').style.display = 'block';
            initializeOJSelector();
            logDebug('Modal aberto e seletor inicializado');
        }
        
        function closeModal() {
            document.getElementById('servidor-v2-modal').style.display = 'none';
            logDebug('Modal fechado');
        }
        
        // Inicialização do seletor
        function initializeOJSelector() {
            const container = document.getElementById('oj-selector-v2');
            
            if (!container) {
                logDebug('ERRO: Container oj-selector-v2 não encontrado!');
                return;
            }
            
            if (!window.ojList || window.ojList.length === 0) {
                loadOJData();
            }
            
            if (window.ojList && window.ojList.length > 0) {
                try {
                    if (window.ojSelectors['oj-selector-v2']) {
                        delete window.ojSelectors['oj-selector-v2'];
                    }
                    
                    window.ojSelectors['oj-selector-v2'] = new OJSelector('oj-selector-v2', window.ojList);
                    logDebug(`Seletor criado com sucesso! ${window.ojList.length} órgãos disponíveis`);
                } catch (error) {
                    logDebug(`ERRO ao criar seletor: ${error.message}`);
                }
            } else {
                logDebug('ERRO: Lista de OJs vazia ou não carregada');
            }
        }
        
        function loadOJData() {
            try {
                const allOJs = [];
                Object.keys(mockOJData).forEach(cidade => {
                    if (Array.isArray(mockOJData[cidade])) {
                        allOJs.push(...mockOJData[cidade]);
                    }
                });
                
                window.ojList = allOJs.sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
                logDebug(`Dados carregados: ${window.ojList.length} órgãos`);
            } catch (error) {
                logDebug(`ERRO ao carregar dados: ${error.message}`);
                window.ojList = [];
            }
        }
        
        function testOJSelector() {
            const selector = window.ojSelectors['oj-selector-v2'];
            if (selector) {
                const selected = selector.getSelectedOJs();
                logDebug(`Teste do seletor: ${selected.length} órgãos selecionados`);
                if (selected.length > 0) {
                    logDebug(`Órgãos selecionados: ${selected.join(', ')}`);
                }
            } else {
                logDebug('ERRO: Seletor não encontrado para teste');
            }
        }
        
        function loadExampleOJs() {
            const selector = window.ojSelectors['oj-selector-v2'];
            if (selector) {
                selector.selectedOJs = [
                    '1ª Vara do Trabalho de Campinas',
                    '2ª Vara do Trabalho de São Paulo',
                    'Vara do Trabalho de Santos'
                ];
                selector.updateSelectedDisplay();
                selector.updateHiddenInput();
                selector.renderOptions();
                logDebug('Exemplos de OJs carregados');
            } else {
                logDebug('ERRO: Seletor não encontrado para carregar exemplos');
            }
        }
        
        function runTests() {
            logDebug('=== INICIANDO TESTES ==>');
            
            // Teste 1: Verificar container
            const container = document.getElementById('oj-selector-v2');
            logDebug(`Teste 1 - Container existe: ${container ? 'SIM' : 'NÃO'}`);
            
            // Teste 2: Verificar dados
            logDebug(`Teste 2 - Dados carregados: ${window.ojList ? window.ojList.length : 0} órgãos`);
            
            // Teste 3: Verificar seletor
            const selector = window.ojSelectors['oj-selector-v2'];
            logDebug(`Teste 3 - Seletor existe: ${selector ? 'SIM' : 'NÃO'}`);
            
            if (selector) {
                logDebug(`Teste 3.1 - Órgãos no seletor: ${selector.ojList.length}`);
                logDebug(`Teste 3.2 - Órgãos selecionados: ${selector.selectedOJs.length}`);
            }
            
            // Teste 4: Verificar elementos DOM
            if (container) {
                const searchInput = container.querySelector('.oj-search-input');
                const dropdown = container.querySelector('.oj-dropdown');
                const selectedDisplay = container.querySelector('.oj-selected-display');
                
                logDebug(`Teste 4.1 - Input de busca: ${searchInput ? 'SIM' : 'NÃO'}`);
                logDebug(`Teste 4.2 - Dropdown: ${dropdown ? 'SIM' : 'NÃO'}`);
                logDebug(`Teste 4.3 - Display selecionados: ${selectedDisplay ? 'SIM' : 'NÃO'}`);
            }
            
            logDebug('=== TESTES CONCLUÍDOS ==>');
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            loadOJData();
            logDebug('Página carregada e dados inicializados');
        });
    </script>
</body>
</html>